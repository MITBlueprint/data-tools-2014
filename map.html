<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
    html {
        height: 100%
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0
    }
    #map-canvas {
        height: 100%;
    }
    h2 {
        font-size: 12px;
        margin: 0;
        padding: 0;
    }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false">
    </script>
    <script type="text/javascript" src="highschools.js">
    </script>
    <script type="text/javascript">
    var map;
    var geocoder;
    var totalSchools = 0;
    var totalCount = 0;
    var Boston = new google.maps.LatLng(42.358431, -71.059773)

        function initialize() {
            geocoder = new google.maps.Geocoder();

            var mapOptions = {
                center: new google.maps.LatLng(39.232253, -96.020508),
                zoom: 5,
                scrollwheel: true,
                minZoom: 5,
                maxZoom: 8
            };

            map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);

            var i = 0;

            for (var name in highschools) {

                i++;

                totalSchools++;
                totalCount += highschools[name].count;

                var locationColor = 0;

                if (google.maps.geometry.spherical.computeDistanceBetween(Boston, highschools[name].center) < 100000) {
                    locationColor = '#2400e0';
                } else {
                    locationColor = '#FF0000';
                }

                var highschoolOptions = {
                    strokeColor: locationColor,
                    strokeOpacity: 1,
                    strokeWeight: 3,
                    fillColor: locationColor,
                    fillOpacity: 0.5,
                    map: map,
                    clickable: true,
                    center: highschools[name].center,
                    radius: Math.log(highschools[name].count + 1) * (1 / (map.getZoom() - 4 )) * 30000
                };


                var hsCircle = new google.maps.Circle(highschoolOptions);
                addInfoWindow(hsCircle, name, highschools[name].count);
                addCircleZoom(hsCircle, highschools[name].count);

            };

            var infowindow = new google.maps.InfoWindow({
                content: '<h2>Total Schools</h2>' + totalSchools + '<h2>Total Students</h2>' + totalCount,
                position: new google.maps.LatLng(28.917923, -122.849609)
            });

            infowindow.open(map);

        }

    google.maps.event.addDomListener(window, 'load', initialize);

    function addCircleZoom(circle, count) {
        google.maps.event.addListener(map, 'zoom_changed', function() {
            var newzoom = map.getZoom();
            if (newzoom == 8) {
                circle.setRadius((Math.log((count + 1)*.8)) * 4000);
            } else {
                circle.setRadius(Math.log(count + 1) * (1 / (newzoom - 4)) * 30000);
            }
        });
    }

    function addInfoWindow(hsCircle, name, count) {
        var hsInfo = new google.maps.InfoWindow({
            content: '<h2>' + name + '</h2>' + count,
            disableAutoPan: true
        });

        google.maps.event.addListener(hsCircle, 'mouseover', function() {
            var infocenter = hsCircle.getCenter();
            var p = infocenter.lat() + 0.12;
            hsInfo.setPosition(new google.maps.LatLng(p, infocenter.lng()));
            hsInfo.open(map);
        });

        google.maps.event.addListener(hsCircle, 'click', function() {
            map.panTo(hsCircle.getCenter());
            map.setZoom(7);
        });

        google.maps.event.addListener(hsCircle, 'mouseout', function() {
            setTimeout(function() {
                hsInfo.close();
            }, 300);
        });
    }
    </script>
</head>

<body>
    <div id="map-canvas" />
</body>

</html>
